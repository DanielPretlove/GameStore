@page "/game/update/{id}"
@using GameStore.Web.Shared.Models.SummaryModels;
@using System.Text.Json
@using System.Text

@inject NavigationManager UriHelper
@inject HttpClient http

@if (gameSummary != null)
{
	<MudCard>
		<MudCardContent>
			<MudForm @ref="form" @bind-IsValid="@success">
				<MudText Typo="Typo.h3">Edit Game Data</MudText>
				<MudTextField @bind-Value="@gameSummary.Name" T="string" Label="Name" Required="true" RequiredError="Name is required!" />
				<MudTextField @bind-Value="@gameSummary.Description" T="string" Label="Description" Required="true" RequiredError="Description is required!" />
				<MudTextField @bind-Value="@gameSummary.ReleaseDate" T="string" Label="ReleaseDate" Required="true" RequiredError="ReleaseDate is required!" />
			</MudForm>
		</MudCardContent>
		<MudCardActions>
			<MudButton Variant="Variant.Filled" StartIcon="@Icons.Filled.ArrowBack" OnClick="@(() => ReturnToViewGameDetails())">Go Back</MudButton>
			<MudButton Disabled="@updateState" Variant="Variant.Filled" StartIcon="@Icons.Filled.Save" Color="Color.Info" OnClick="@(() => UpdateGameData())">
				@if (updateState)
				{
					<MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
					<MudText Class="ms-2">Processing</MudText>
				}
				else
				{
					<MudText>Save</MudText>
				}

			</MudButton>
		</MudCardActions>
	</MudCard>

	<br />
}

@*
	First display the data based on the id of the data
	with all of the inputs showing
	have a button of save and go back
	and make sure they work
	basically the gist of this
*@

@code {
	[Parameter]
	public string? Id { get; set; }
	public bool success;
	public bool updateState = false;
	public MudForm form;
	public GameSummaryModel gameSummary;

	protected override async Task OnInitializedAsync()
	{
		gameSummary = await GetCurrentGame();
	}

	public void ReturnToViewGameDetails()
	{
		UriHelper.NavigateTo("/game/" + Id);
	}

	public async Task<GameSummaryModel> GetCurrentGame() =>
		await http.GetFromJsonAsync<GameSummaryModel>($"/api/Game/{Id}");

	public async Task UpdateGameData()
	{

		HttpContent body = new StringContent(JsonSerializer.Serialize(gameSummary), Encoding.UTF8, "application/json");
		var response = await http.PutAsync($"/api/Game/{Id}", body);
		if (response.IsSuccessStatusCode)
		{
			var content = await response.Content.ReadAsStringAsync();
			if (!string.IsNullOrEmpty(content))
			{
				var objDeserializeObject = JsonSerializer.Deserialize<GameSummaryModel>(content);

				Console.WriteLine("Data Updated Successfully.");
			}

			updateState = true;

			await Task.Run(async () =>
			{
				await Task.Delay(3000);
				ReturnToViewGameDetails();
			});
		}
	}
}
