@page "/store/update/{id}"
@using GameStore.Web.Shared.Models.SummaryModels;
@using System.Text.Json
@using System.Text

@inject NavigationManager UriHelper
@inject HttpClient http

@if(storeSummary != null)
{
	<MudCard>
		<MudCardContent>
			<MudForm @ref="form" @bind-IsValid="@success">
				<MudText Typo="Typo.h3">Edit Store Data</MudText>
				<MudTextField @bind-Value="@storeSummary.Description" T="string" Label="Description" Required="true" RequiredError="Description is required!" />
				<MudTextField @bind-Value="@storeSummary.Name" T="string" Label="Name" Required="true" RequiredError="Name is required!" />
				<MudTextField @bind-Value="@storeSummary.Address" T="string" Label="Address" Required="true" RequiredError="Address is required!" />
			</MudForm>
		</MudCardContent>
		<MudCardActions>
			<MudButton Variant="Variant.Filled" StartIcon="@Icons.Filled.ArrowBack" OnClick="@(() => ReturnToViewStoreDetails())">Go Back</MudButton>
			<MudButton Disabled="@updateState" Variant="Variant.Filled" StartIcon="@Icons.Filled.Save" Color="Color.Info" OnClick="@(() => UpdateStoreData())">
				@if (updateState)
				{
					<MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
					<MudText Class="ms-2">Processing</MudText>
				}
				else
				{
					<MudText>Save</MudText>
				}

			</MudButton>
		</MudCardActions>
	</MudCard>

	<br />
}

@*
	First display the data based on the id of the data
	with all of the inputs showing
	have a button of save and go back
	and make sure they work
	basically the gist of this
*@

@code {
	[Parameter]
	public string? Id { get; set; }
	public bool success;
	public bool updateState = false;
	public MudForm form;
	public GameStoreSummaryModel storeSummary;

	protected override async Task OnInitializedAsync()
	{
		storeSummary = await GetCurrentStore();
	}

	public void ReturnToViewStoreDetails()
	{
		UriHelper.NavigateTo("/store/" + Id);
	}

	public async Task<GameStoreSummaryModel> GetCurrentStore() =>
		await http.GetFromJsonAsync<GameStoreSummaryModel>($"/api/GameStore/{Id}");

	public async Task UpdateStoreData()
	{

		HttpContent body = new StringContent(JsonSerializer.Serialize(storeSummary), Encoding.UTF8, "application/json");
		var response = await http.PutAsync($"/api/GameStore/{Id}", body);
		if(response.IsSuccessStatusCode)
		{
			var content = await response.Content.ReadAsStringAsync();
			if (!string.IsNullOrEmpty(content))
			{
				var objDeserializeObject = JsonSerializer.Deserialize<GameStoreSummaryModel>(content);

				Console.WriteLine("Data Updated Successfully.");
			}
		
			updateState = true;

			await Task.Run(async () =>
			{
				await Task.Delay(3000);
				ReturnToViewStoreDetails();
			});
		}
	}
}
